@model Brio.Models.SendFeedback
@{
    ViewBag.Title = "КОНТАКТЫ";
    Layout = "~/Views/Layouts/LayoutDefault.cshtml";
}



<div class="container run1">
    <div data-id="0" class="slider"></div>
</div>
<div class="block_ins">
    <div class="title">
        @ViewBag.Title
    </div>
    <article class="page-content">
        <div class="articles">
            <div class="contact-container">
                <div class="adress">
                    <div class="adress1">
                        @{var contacts = ViewBag.Contacts as Brio.Models.Company;}
                        @contacts.Adress,<br />
                        @contacts.Postcode, а/я @contacts.POBox
                    </div>
                    <div class="telephone">
                        тел./факс: @contacts.Phone,<br />
                        @contacts.Phone2
                    </div>
                </div>
                <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d2241.8748528257734!2d37.647777999999995!3d55.812773!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x46b535dcfe89da29%3A0x7d0a122acbdd646c!2z0JzQsNC70L7QvNC-0YHQutC-0LLRgdC60LDRjyDRg9C7LiwgMTYsINCc0L7RgdC60LLQsCwgMTI5MTY0!5e0!3m2!1sru!2sru!4v1412837099872" height="220" frameborder="0" style="border:0; width:100%"></iframe>
            </div>
        </div>
        <div class="brio-tasks">
            @using (Html.BeginForm("SendFeedback", "Contact", FormMethod.Post, new { @class = "pure-form", enctype = "multipart/form-data" }))
            {
                <fieldset id="feedback_form" style="position: absolute; margin-left: 10%; width: 80%;">
                    @Html.ValidationSummary(true)
                    <p>@ViewBag.Message</p>
                    <div class="feedback_title">ОБРАТНАЯ СВЯЗЬ</div>
                    @Html.TextBoxFor(model => model.Name, new { placeholder = "Имя" })
                    @Html.TextBoxFor(model => model.Email, new { placeholder = "E-mail" })
                    @Html.TextBoxFor(model => model.Phone, new { placeholder = "Телефон" })
                    @Html.TextAreaFor(model => model.Message, 4, 22, new { placeholder = "Текст" })
                    <button class="button-error pure-button feedback">ОТПРАВИТЬ</button>
                </fieldset>
            }
        </div>
    </article>
</div>

<script>
    (function () {
        $(".pure-button.feedback").bind("click", function(event){
            event.preventDefault();
            var that = this;
            var isDataValid = true;
            $(that).parents("#feedback_form").find("input, textarea").each(function () {
                if ($(this).val() == "") {
                    isDataValid = false;
                    $(this).addClass("error");
                }
                else {
                    $(this).removeClass("error");
                }
            });

            if (!validateEmail($("input[name='Email']").val())) {
                isDataValid = false;
                $("#feedback_form input[name='Email']").addClass("error");
            }
            else {
                $("#feedback_form input[name='Email']").removeClass("error");
            }

            if (isDataValid) {
                postFeedback();
            }
        });
    })();

    function validateEmail(email) { 
        var re = /^(([^<>()[\]\\.,;:\s@@\"]+(\.[^<>()[\]\\.,;:\s@@\"]+)*)|(\".+\"))@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }

    function postFeedback() {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: "/Contact/SendFeedback",
            data: $("#feedback_form").serialize(),
            success: function (response) {
                if (response.success){
                    $("#feedback_form").find("input, textarea").each(function(){
                        $(this).val("");
                    });
                }
                $(".pure-button.feedback").attr("disabled", true).text(response.message);
                setTimeout(function(){
                    $(".pure-button.feedback").attr("disabled", false).text("ОТПРАВИТЬ");
                }, 3000);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.log("request failed");
            },
            processData: false,
            async: false
        });
    }
</script>

